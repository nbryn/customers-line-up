import {BUSINESS_ROUTE} from '../../app/RouteConstants';
import {
    BUSINESS_ALL_TAG,
    BUSINESS_BY_OWNER_TAG,
    BUSINESS_TAG,
    baseApi,
    USER_TAG,
    BUSINESS_AGGREGATE_TAG,
} from '../../app/Store';
import {
    BusinessApi,
    type CreateBusinessRequest,
    type UpdateBusinessRequest,
    type BusinessDto,
    type BusinessAggregateDto,
} from '../../autogenerated';
import {apiMutation, apiQuery} from '../../shared/api/Api';

const BUSINESS_UPDATED_MSG = 'Business Updated';

const BUSINESS_CREATED_SUCCESS_INFO = {
    message: 'Business Created - Go to my businesses to see your businesses',
    toastInfo: {buttonText: 'My Businesses', navigateTo: BUSINESS_ROUTE},
};

const businessApi = baseApi.injectEndpoints({
    endpoints: (builder) => ({
        getBusinessById: builder.query<BusinessDto | undefined, string>({
            providesTags: [BUSINESS_TAG],
            queryFn: async (businessId, api) => ({
                data: await apiQuery(
                    async (queryApi) => (await queryApi.getBusiness(businessId)).data.business,
                    api
                ),
            }),
        }),
        getBusinessAggregateById: builder.query<BusinessAggregateDto | undefined, string>({
            providesTags: [BUSINESS_AGGREGATE_TAG],
            queryFn: async (businessId, api) => ({
                data: await apiQuery(
                    async (queryApi) =>
                        (
                            await queryApi.getBusinessAggregate(businessId)
                        ).data.business,
                    api
                ),
            }),
        }),
        getBusinessesByOwner: builder.query<BusinessAggregateDto[], void>({
            providesTags: [BUSINESS_BY_OWNER_TAG],
            queryFn: async (_, api) => ({
                data: await apiQuery(
                    async (queryApi) =>
                        (await queryApi.getBusinessesByOwner()).data.businesses ?? [],
                    api
                ),
            }),
        }),
        getAllBusinesses: builder.query<BusinessDto[], void>({
            providesTags: [BUSINESS_TAG, BUSINESS_BY_OWNER_TAG],
            queryFn: async (_, api) => ({
                data: await apiQuery(
                    async (queryApi) => (await queryApi.getAllBusinesses()).data.businesses ?? [],
                    api
                ),
            }),
        }),
        createBusiness: builder.mutation<void, CreateBusinessRequest>({
            invalidatesTags: [BUSINESS_ALL_TAG, BUSINESS_BY_OWNER_TAG, USER_TAG],
            queryFn: async (createBusinessRequest, api) => ({
                data: await apiMutation(
                    async (businessApi) => await businessApi.createBusiness(createBusinessRequest),
                    BusinessApi,
                    api,
                    BUSINESS_CREATED_SUCCESS_INFO
                ),
            }),
        }),
        updateBusiness: builder.mutation<void, UpdateBusinessRequest>({
            invalidatesTags: [BUSINESS_AGGREGATE_TAG, BUSINESS_ALL_TAG, BUSINESS_BY_OWNER_TAG],
            queryFn: async (updateBusinessRequest, api) => ({
                data: await apiMutation(
                    async (businessApi) => await businessApi.updateBusiness(updateBusinessRequest),
                    BusinessApi,
                    api,
                    {message: BUSINESS_UPDATED_MSG}
                ),
            }),
        }),
    }),
});

export const {
    useGetBusinessByIdQuery,
    useGetBusinessAggregateByIdQuery,
    useGetAllBusinessesQuery,
    useGetBusinessesByOwnerQuery,
    useUpdateBusinessMutation,
    useCreateBusinessMutation,
} = businessApi;
